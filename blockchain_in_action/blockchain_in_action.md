# front matter

構成

この本は3部構成で12章まであります。

* 第1部（1～4章）では、ブロックチェーンの基礎知識とスマートコントラクトの設計・開発について説明しています。
  * 第1章では、ブロックチェーンの3つのD--分散化、非干渉化、分散型不変の台帳--を紹介し、ブロックチェーンのハイレベルな概念図を示しています。
  * 第2章では、Ethereumブロックチェーン上のスマートコントラクトをやさしく紹介し、スマートコントラクトを開発し、Solidity言語でコーディングし、ウェブベースの統合開発環境Remixでデプロイし、取引を行うための設計原則を適用しています。分散型カウンター（Counter.sol）と航空会社コンソーシアム（ASK.sol）のスマートコントラクトが開発されています。
  * 第3章では、スマートコントラクトのコードに信頼性と完全性を付加するための技術について説明しています。デジタル民主主義における投票を表現する投票用スマートコントラクト（Ballot.sol）を紹介し、段階的に開発しています。
  * 第4章では、スマートコントラクトのロジックとウェブベースのユーザーインターフェイスを備えた分散型アプリケーション（Dapp）の設計と開発について紹介しています。スマートコントラクトとウェブアプリケーションを開発・実行するために、Node.jsベースのTruffleツール群が紹介されています。Ballotアプリケーション（Ballot-Dapp）を使って、Truffleベースの開発手順とローカルのGanacheテストチェーンへの展開を説明します。第3章では、スマートコントラクトのコードに信頼性と完全性を付加するための技術について説明しています。デジタル民主主義における投票を表現する投票用スマートコントラクト（Ballot.sol）を紹介し、段階的に開発しています。 
* 第2部（第5章～第8章）では、エンドツーエンドのDapp開発について、オンチェーンデータ、セキュリティ、プライバシーといったブロックチェーン特有の機能を追加しています。
  * 第5章では、ブロックチェーン・プログラミングの文脈でセキュリティとプライバシーを紹介しています。暗号とハッシュのアルゴリズムとテクニックが高いレベルで議論されています。また、ブラインドオークションのスマートコントラクト（BlindAuction.sol）を使って概念を説明します。
  * 第6章では、ブロックチェーンプログラミングに特有のオンチェーンデータとオフチェーンデータの概念を紹介しています。ブラインドオークションとASKスマートコントラクトをDapps（BA-Dapp、ASK-Dapp）に拡張し、オンチェーンとオフチェーンのデータを使った開発を実演します。ブロックチェーンのイベントやログの定義、エミット、アクセスについても説明しています。
  * 第7章では、ウェブアプリケーションが基盤となるブロックチェーンサービスにアクセスできるEthereumのweb3 APIに焦点を当てています。ブロックチェーンのサイドチャネルのコンセプトが紹介され、大規模なプラスチックの清掃のためのマイクロペイメントチャネル（MPC）アプリケーション（MPC-Dapp）におけるweb3の使用が説明されています。
  * 第8章では、開発したスマートコントラクトをInfuraというパブリッククラウドのようなインフラに展開することについて説明します。Infuraはweb3のプロバイダであり、Ropsten（メインネットとIPFS）などのパブリックブロックチェーンへのゲートウェイでもあります。InfuraとRopstenへのパブリックな展開は、MPCとブラインドオークションのスマートコントラクトを展開することで説明されています。
* 第3部（9～12章）では、トークン、イーサリアム標準、自動テスト、実世界のアプリケーション開発のためのロードマップなど、イーサリアムDappsのエコシステムに対する見方を広げることがテーマです。
  * 第9章は、デジタル資産のトークン化についてです。不動産トークンであるRES4-Dappが、Ethereum標準の非ファンジブルトークンERC721に基づいて開発されています。
  * 第10章は、TruffleのJSベースのテストフレームワークを使用してテストスクリプトを書き、それを実行することに完全に専念しています。自動化されたテストスクリプトの書き方は、本書ですでに取り上げられている3つのスマートコントラクト（カウンター、投票、ブラインドオークション）で説明されています。
  * 第11章では、これまでに説明したすべてのコンセプト、ツール、テクニックをエンド・ツー・エンドでロードマップし、教育的資格認定のためのアプリケーションにまとめています。DCC-Dappです。
  * 第12章では、課題が山積している今後の道のりを振り返り、あなたが貢献できる素晴らしい機会を探ります。
* デザインプロセスに役立つ2つの付録が用意されています。
  * 付録Aでは、UML（Unified Modeling Language）を使った設計表現について再確認できます。スマートコントラクトの設計で使用される構造、動作、インタラクションのモデリングとダイアグラムを説明しています。
  * 付録Bでは、ブロックチェーンアプリケーション開発の指針として、本書で紹介されている設計原則を捉えています。

# Part 1. Getting started with blockchain programming

# 1 Blockchain basics

ブロックチェーンの基礎的な概念を説明する章

## 1.1 From Bitcoin to blockchain

## 1.2 What is blockchain

## 1.3 Blockchain programming

4つの基礎的な重要概念

* 非中央集権型インフラ - 特殊なコンピューティングハードウェアとソフトウェアスタックが、ブロックチェーンプロトコル、スマートコントラクト、アプリケーション（Dapps）をサポートします。このインフラの主な構成要素は、コンピューティング・ノードと、ノードを接続するネットワークです（1.3.1項）。
* 分散型台帳技術 --インフラの上にあるのが台帳です。取引やデータは、すべての関係者の台帳に同時に記録される。すべての関係者が同じ事実を記録するため、台帳は分散している。また、各ブロックは前のブロックの署名とリンクしているため、改ざんができない（1.3.2項）。
* 遮断プロトコル --分散型システムの参加者は、同じブロックチェーンプロトコルに従って接続し、相互に通信や取引を行います。プロトコルは、全員が従うべきルールの集合体です。例えば、EthereumとHyperledgerは、2つの異なるブロックチェーンプロトコルです（1.3.3項）。
* Trust enabler --参加者が分散しているシステムでは、中央当局や銀行などの仲介者が存在しません。そのため、ガバナンスや実績、コンプライアンスなどのルールを、仲介者を介さずに自動的に実現するインフラが必要になります。ブロックチェーンソフトウェアは、トラストイネーブラ（1.3.4項）の役割を担います。

### 1.3.1 Decentralized infrastructure

### 1.3.2 Distributed ledger technology

### 1.3.3 Disintermediation protocol

### 1.3.4 Trust enabler

## 1.4 Motivating scenarios

blockchainが実際どんなシナリオで役立つか。

### 1.4.1 Automatic and consistent data collection

情報の収集に役立つらしい

### 1.4.2 Timely information sharing

情報の共有に役立つらしい

### 1.4.3 Verifiable compliance

機密情報の漏洩を防げる

### 1.4.4 Auditable actions for provenance

監査可能なログが残る

### 1.4.5 Guidance for governance

薬の誤用が防げるらしい

### 1.4.6 Attribution of action

誰が何をしたかを記録でき、決済料金などの算出を自動化できる。

### 1.4.7 Pandemic management

接触者追跡なんかに用いることができる。covid-19

## 1.5 Retrospective

この図を見ると、blockchain技術はブレークスルーだ。
![](スクリーンショット%202021-04-28%2018.35.41.png)


## 1.6 Summary

* コンピュータシステムは、分散型の中央集権的なシステムから、参加者がピアツーピアで取引を行い、通常の信頼の境界を越えて運用される分散型のシステムへと移行しています。
* ブロックチェーンは、ブロックチェーンの運用を管理する信頼層、インフラ、プロトコルを提供することで、分散型の運用を可能にします。
* ブロックチェーンは、分散化、非干渉化を可能にし、実行中のアプリケーションに関する関連情報を記録する分散型の不変の台帳を実現します。
* ブロックチェーンプロトコルは、参加者、コンピューティングノード、ノードを接続するネットワーク、ノード上の分散型アプリケーションスタック、トランザクション、ブロック、ブロックのチェーンを管理するルールを定義します。
* イーサリアムのブロックチェーンアプリケーションスタックは、スマートコントラクトと呼ばれる計算フレームワークと、その実行環境をサポートしています。
* ブロックチェーン技術を利用した画期的な分散型アプリケーションを様々な領域で開発することで、現在進行中のデジタル化の取り組みを破壊し、イノベーションを起こすことができる膨大な機会があります。
* 企業は、このイノベーションを進めるために、思想家、デザイナー、開発者を必要としています。モノのインターネット（IoT）からウェブに至るまで、あらゆるレベルのアプリケーション開発者がブロックチェーンについて学ぶことが必須となります。このブロックチェーンの知識を提供し、関連する設計や開発のスキルを可能にすることが、本書の包括的な目標です。

# 2 Smart contracts

スマートコントラクトの仕組みを見ていく

この章では設計原則を学ぶ。

実装においては下記が必要になる。

* ブロックチェーン・プラットフォーム
* スマートコントラクトをコーディングするための言語
* 開発、コンパイル、デプロイ、テストに適した環境

プラットフォームをイーサリアムとし、Solidityという言語を使ってスマートコントラクトをコーディングする。
そのコードをRemixというIDEにデプロイして動作確認する。

Dapps??

## 2.1 The concept of a smart contract

### 2.1.1 Bitcoin transactions versus smart contract transactions

Bitcoinは送金しかトランザクションがないが、イーサリアムなど、スマートコントラクトがあるブロックチェーンはあらゆるロジックをサポートできる.

### 2.1.2 What does a smart contract do?

スマートコントラクトは下記のようなことを受け持つ。

* アプリケーション固有の条件を検証・確認するためのビジネスロジック層を表します。
* ブロックチェーン上での操作のルールを指定することができます。
* 非中央集権的なネットワークにおける資産の移転に関するポリシーの実装を容易にします。
* 参加者のアカウントや他のスマートコントラクトのアカウントからのメッセージや関数の呼び出しによって呼び出される機能が組み込まれています。これらのメッセージとその入力パラメータは、送信者のアドレスやタイムスタンプなどの追加メタデータとともに、ブロックチェーンの分散型台帳に記録される取引につながります。
* ブロックチェーンベースの分散型アプリケーションのソフトウェアベースの仲介者として機能します。
* ブロックチェーンの機能のパラメータを指定することで、ブロックチェーンにプログラマビリティとインテリジェンスを追加します。

## 2.2 Design of a smart contract

counterアプリ？を設計してみる。

```
設計原則1
スマートコントラクトをコード化する前に設計し、開発し、テストチェーンにデプロイし、本番ブロックチェーンにデプロイする前に徹底的にテストします。スマートコントラクトがデプロイされると、それは不変であるためです。
```

```
設計原則2
システムのユーザーとユースケースを定義する。ユーザーとは、設計するシステムからのアクションやインプットを生み出し、アウトプットを受け取る主体である。
```

### 2.2.1 A use case diagram for the counter

umlでユースケース図を作成している。
![](スクリーンショット%202021-04-29%2011.11.53.png)

### 2.2.2 Data assets, peer participants, roles, rules, and transactions

```
設計原則3
設計するシステムのデータ資産、仲間の参加者とその役割、実施すべきルール、記録すべきトランザクションを定義する。
```

台帳に記録させない、ビューオンリーの関数を定義することもできる。

### 2.2.3 From class diagram to contract diagram

```
設計原則4
名前、データ資産、機能、機能の実行とデータへのアクセスのルールを指定する契約図を定義する。
```

## 2.3 Development of a smart contract code

Solidityはスマートコントラクト開発のために作成された言語

### 2.3.1 Solidity language

静的型付け言語

### 2.3.2 Smart contract code for Counter

動かすまでにやる手順

* ブラウザでRemix Web IDEを開きます。
* 言語はSolidityを選択します。(Vyperはもう一つの言語としてサポートされています。)
* IDEで、左ペインの上部にある+アイコンをクリックして、新しいファイルを作成します。
* 開いたポップアップ・ウィンドウで、ファイル名をCounter.solとする。(.solはSolidityで書かれたプログラムのファイルタイプです。)
* エディタウィンドウにリスト2.1のCounterのコードを入力(Enter)またはコピーします。

## 2.4 Deploying and testing the smart contract

### 2.4.1 The Remix IDE

* 左側のファイルエクスプローラーでは、ファイルの作成と管理を行います。ここでは、ファイルのオープン、クローズ、作成、削除などができます。作成されたファイルは自動的にRemix（クラウド）サーバに保存されます。また、ローカルのドライブやフォルダに同期させることもできます。
* 真ん中のエディタースペースでは、コードを入力したり、スマートコントラクトの.solファイルや取引記録の.jsonファイルなどのファイルを確認したりします。また、コードを入力する際にエラーを指摘してくれるジャストインタイム・コンパイラ（オプション）も搭載されています。
* エディタウィンドウのすぐ下にある出力コンソールでは、トランザクションを表示して記録の確認を確認できるほか、エラーやデバッグの詳細を確認できます。
* 左側パネルのツールチェーンには、コンパイルされたコードをデプロイするためのコマンドを表すアイコンが用意されています。CompileとDeployのアイコンをクリックした後、Deployボタンをクリックするとスマートコントラクトがデプロイされます。
* ブロックチェーン・シミュレータは、実行環境（JavaScript VM）と、ライブ・ブロックチェーン・ネットワークへの接続を提供します。Remix IDEでは、テスト用のブロックチェーン用のアカウント・アドレスとアイデンティティのセットを提供しています。アカウント番号は参加者を識別します。テスト用に用意されているアカウントは10個と少ないですが、必要に応じてさらに作成することができます。
* 左下のユーザーインタラクションパネルでは、デプロイされたスマートコントラクトと対話して取引を実行することができます。このパネルでは、すべてのパブリック関数とデータが公開され、関数を呼び出すためのボタンや、入力パラメータ用のテキストボックスも表示されます。呼び出しの出力がある場合は、関数ボタンのすぐ下に表示されます。
* ブロックチェーンに記録されたすべてのトランザクションは、簡単に確認できるように.jsonファイルで提供されます。左側のパネルの中央に「Transactions Recorded」ボタンが表示されています。

### 2.4.2 Deployment and testing

* ファイルエクスプローラーのアイコンを開き、濃い＋マークをクリックします。ポップアップしたボックスに、契約名としてCounter.solを入力します。Counter.solファイルからコードをエディタウィンドウにコピーし、Compileアイコンをクリックします。コンパイルボタンが表示されるので、それをクリックします。自動コンパイルのチェックボックスをクリックして、このステップを省略することもできます）。
* 環境がJavaScript VMに設定されていることを確認して、コマンドメニューの「実行」アイコンをクリックします。左側のパネルの中央に「Counter.sol」というタイトルのバナーが表示されているはずです。
* これで、デプロイと探索の準備が整いました。Deploy and Run Transactions」アイコンをクリックします。左のパネルにある「Deploy」ボタンをクリックします。次に，図2.7に示すように，「Deployed Contracts」の横にある小さな下向き矢印をクリックします．画面の下にインタラクションパネルが表示されます。
* これで、スマートコントラクトと対話し、その動作を確認するための準備が整いました。以下は対話のサンプルです。「Initialize」ボックスに456を入力し、「Initialize」ボタンをクリックした後、「Get」ボタンをクリックして値を確認します。この操作を繰り返すには、「Increment」と「Decrement」のボックスに値を入力して、「Get」をクリックします。

一旦飛ばす

### 2.4.3 Key takeaways


## 2.5 What makes a blockchain contract smart?

blockchainの文脈では、username:passwordによる認証を行ったりはしない。

## 2.6 Decentralized airline system use case

航空会社の席予約のシステムを例に考えてみる

### 2.6.1 ASK definition

### 2.6.2 Sequence of operations

1. 顧客が航空会社Aで保有している座席を変更したいと申し出ます。
1. 航空会社Aのエージェントやアプリケーションは、ASKコンソーシアムのメンバー間で共有されているスマートコントラクト・ロジックを使ってリクエストを検証し、有効性を確認します。
1. 検証されると、リクエストTxは確認され、分散型の不変の台帳に記録されます。これで、コンソーシアムの全員が、正当なリクエストが行われたことを知ることができます。
1. 最もシンプルな設計では，航空会社Aのエージェントが，検証・有効化されたリクエスト（VVRequest）を航空会社Bに送信する（別の方法として，多くの航空会社がリクエストを受信し，いずれかの航空会社が応答できるブロードキャストモデルを使用することもできる）．
1. 航空会社Bのエージェントまたはアプリケーションは、航空会社のデータベースをチェックして空席状況を確認する。
1. 航空会社Bのエージェントは、コンソーシアムの共通の関心事と共有ルールを検証し、妥当性を確認する共有スマートコントラクトロジックを通じて応答します。
1. 検証されると、応答Txが確認され、分散型の不変の台帳に記録されます。これで、コンソーシアムの全員が、レスポンスが送信されたことを知ることができます。
1. 航空会社Bは、航空会社Aのエージェントにレスポンス（VVResponseで示される）を送信します。
1. 航空会社Aは、データベースを更新し、変更が行われたことを通知します。
1. 航空会社Bのエージェントは、お客様にフライトの座席などの情報を送信します。航空会社Bはデータ資産を保有しており、航空会社Aではなく、既知の顧客に直接転送することに注意してください）。
1. 支払いは、参加している航空会社が共有しているスマートコントラクトで保有しているエスクローやデポジットを使って、ピアツーピアのTxsで決済されます。支払いの決済は、システム内の他の適切な操作に組み込むことができますが、共有スマートコントラクトによって処理され、元帳に記録されます。この決済は、スマートコントラクトのロジックによって自動的に実行されます。

## 2.7 Airlines smart contract
 
### 2.7.1 Peer participants, data assets, roles, rules, and transactions

### 2.7.2 Airlines smart contract code

Solidityでの予約語

* address 
* struct 
* mapping
* modifier

### 2.7.3 ASK smart contract deployment and testing

