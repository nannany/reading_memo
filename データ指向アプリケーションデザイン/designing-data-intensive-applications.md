# はじめに

### 近年のIT業界について説明

データベースや分散システムがめっちゃ発達しましたよ。

### データ指向についての定義
そもそもデータ指向とは？

```
本書では、CPUのサイクルがボトルネックとなる演算指向のアプリケーションに対して、
データの量や複雑さ、変化の速度が主な課題であるアプリケーションのことをデータ指向と呼びます。
```

### この本の目的

* 技術の進歩は早くとも、その裏には原理原則がある。
* データシステムがどのように動作するかだけではなく、なぜそのような動きになるかを見出していく。

## 本書が対象とする読者

* たとえば数百万のユーザーを持つ Web アプリケーションやモバイルアプリケーションをサ ポートするために、データシステムをスケーラブルにする方法を学びたい。
* アプリケーションの可用性を高め(すなわちダウンタイムを最小限にとどめ)、頑健な運用 を実現する必要がある。
* システムが成長し、要件や技術が変化していっても、長期的に見てシステムをメンテナンス しやすくする方法を知りたい。
* システムの動作に対して自然に関心があり、大きな Web サイトやオンラインサービスの内 部で何が起きているのかを知りたい。本書は、様々なデータベースやデータ処理のシステム の内部をブレークダウンしていきますが、そういったシステムの中にある賢明な考え方を探 索していくことは大変楽しいことです。

## 本書が対象とする範囲

```
本書で主に見ていくのはデータシステムのアーキテクチャであり、
データシステムが組み合わさってデータ指向のアプリケーションになっていく様子です。
本書には、デプロイメント、運用、 セキュリティ、管理やその他の領域を取り上げる紙面がありません。
これらは複雑で重要な話題で あり、本書では表面的に脚注で取り上げるようなやり方はしません。
これらは専門の書籍で学ぶのにふさわしい話題です。
```

## 本書の概要

1部であらゆるシステムの基礎概念
2部で分散配置されたデータに関すること
3部でデータセット間の情報のやり取りに関すること

# 第1部　データシステムの基礎

１〜４章ではあらゆるデータシステムに当てはまる基本的な概念を見ていく。

## 1章 信頼性、スケーラビリティ、メンテナンス性に優れたアプリケーション

```
本章では、まず私たちが実現しようとしている目標である、信頼性とスケーラビリティを持ちながらメンテナンスしやすいデータシステムの基礎を調べていきます。
そういったことが何を意味するのかを明確にし、それらについての考え方の概要を見て、今後の章で必要になる基礎を押さえていきます。
今後の章はレイヤーごとに進んでいき、データ指向アプリケーションを扱う際に考慮しなければならない設計上の様々な判断を見ていきます。
```


### 1.1 データシステムに関する考察

なぜデータベース、キュー、キャッシュをデータシステムとして一括りで捉えるのか？
いっぱいツールがあって、境界線が曖昧

データシステムの設計における重要な課題として、下記３点に焦点を当てる。

* 信頼性
  * システムは障害があったとしても正しく動き続けるべき
  * 1.2章参照
* スケーラビリティ
  * システムの成長に対して、無理のない方法で対応可能であるべき
  * 1.3章参照
* メンテナンス性
  * 時間が経つにつれて、システムには多くの様々な人々が関わる。こういった人々がシステムの生産性に関われるべき
  * 1.4章参照

### 1.2 信頼性

```
大まかに言って信頼性とは「何か 問題が生じたとしても正しく動作し続けること」と言えるでしょう。
```

```
妥当なのはある種のフォールトに対する耐性について議論することだけなのです。
```

```
本書で扱うフォールトの多くは回復が可能な種類のものです。
```

### 1.2.1 ハードウェアの障害

RAIDやら電源の二重化など、ハードウェアコンポーネントの冗長化で故障率を下げている。

### 1.2.2 ソフトウェアのエラー

システマティックなエラー

* ソフトウェアのバグ。問題のある特定の入力が与えられると、すべてのアプリケーションサーバーのインスタンスがクラッシュしてしまうようなものです。たとえば、2012年6月30日うるう秒の際には、Linuxカーネル中のバグのために多くのアプリケーションが同時にハングしてしまいました [9]。
* プロセスの暴走。CPU時間、メモリ、ディスク領域、ネットワーク帯域など、何らかの共 有リソースを使い切ってしまいます。
* システムが依存しているサービスの問題。システムが依存しているにもかかわらずサービス がスローダウンしてレスポンスを返さなくなったり、壊れたレスポンスを返したりし始めて しまうような場合。
* カスケード障害。これは、1 つのコンポーネント中の小さなフォールトが他のコンポーネン トのフォールトを引き起こし、そしてそのフォールトがさらなるフォールトを引き起こして いくような障害です [10]。

### 1.2.3 ヒューマンエラー

人は信頼できないので、それを踏まえて設計せよ。

* エラーの可能性が最小限になるようにシステムを設計する。たとえば、うまく設計された抽 象化、API、管理インターフェースは、「正しいこと」を行いやすく、「間違ったこと」を行 いにくくしてくれます。ただし、あまりにインターフェースの制約が強くなると、人々はそ れを回避しようとするようになるので、この方策のメリットが損なわれてしまいます。バラ ンスを適切に取るのが難しいところです。
* 人々が最も間違いを犯しやすい部分を、間違いがあれば障害につながりやすいところから分 離します。特に、完全な機能を持ったサンドボックス環境をプロダクション環境とは別に提 供し、実際のユーザーに影響することなく本物のデータを使って実体験を積めるようにする と良いでしょう。
* ユニットテストからシステム全体の結合テストやマニュアルテストまで、すべてのレベルで 徹底的なテストを行いましょう [3]。自動化テストは広く利用され、十分に理解されており、 特に通常の操作では滅多に生じないようなコーナーケースをカバーする上で有益です。
* ヒューマンエラーから迅速かつ容易にリカバリできるようにして、障害が発生した場合のイ ンパクトを最小化できるようにしておきましょう。たとえば、設定の変更のロールバックを 即座にできるようにしておいたり、新しいコードのロールアウトは徐々に行っていったり(こうすることで、予想外のバグがあっても影響されるユーザーを一部にとどめることがで きます)、データを計算し直すツールを提供したり(それまでの計算が正しくないことが判 明した場合に備えて)しましょう。
* パフォーマンスメトリクスやエラーの発生率など、詳細で明確なモニタリングの仕組みを セットアップしましょう。他のエンジニアリング分野では、これはテレメトリと呼ばれます (いったん離陸してしまったロケットで起こっていることを追跡し、障害について理解する ためにはテレメトリが欠かせません [14])。モニタリングを行えば、警告シグナルを早期に 受けることができ、何らかの前提や制約に反していないかをチェックできます。問題が生じた場合、その診断にはメトリクスが欠かせません。
* 優れた管理方法とトレーニングを実践しましょう。これは複雑で重要なことであり、本書の範囲を超えています。

### 1.2.4 信頼性の重要度

## 1.3 スケーラビリティ

### 1.3.1 負荷の表現

```
最適なパラメータの選択がどのようなものになるかは、システムのアーキテクチャに依存します。
Webサーバーなら毎秒のリクエスト数、データベースなら読み書きの比率、チャットルームなら同時アクティブユーザー数、
キャッシュならヒット率などがそうです。おそらくは、平均的な状況が問題になる場合もあれば、
あるいは少数の極端なケースが支配的なボトルネックになっている場合もあるでしょう。
```

Twitterのタイムラインの実装例を出している。これは面白い。

### 1.3.2 パフォーマンスの表現

バッチ処理だとスループット、オンラインシステムだとレスポンスタイムが大事

レスポンスタイムとレイテンシの違いの話、よくわからん。説明下手。

典型的なレスポンスタイムを知るにはパーセンタイルを用いるべき


**HOLブロッキング**
少数の遅いリクエストがキュー詰まりをおこし、それ以外のリクエストにも影響を及ぼすこと。


### 1.3.3 負荷への対処のアプローチ

水平スケール、垂直スケール
手動拡張、自動拡張（エラスティック）
様々なアプローチがある。

```
本書ではこの後、多くの種類の分散データシステムを取り上げ、それらがスケーラビリティだけでなく、
使いやすさやメンテナンス性という面も考慮してやりくりしていることを論じていきます。
```

```
本書では、これらのビルディングブロックやパターンについて述べていきます。
```

# 1.4 メンテナンス性


